
1.1. Install the necessary packages

```{r}
# Install necessary packages
install.packages("devtools")
devtools::install_github("MRCIEU/TwoSampleMR")
devtools::install_github("MRCIEU/ieugwasr")
install.packages("MendelianRandomization")
```

1.2. Load the necessary packages

```{r}
# Load the necessary libraries
library(TwoSampleMR)
library(dplyr)

```

2. Load and format the outcome and summary data

```{r}


# Load exposure summary data
exposure_file <- "/Users/sanjeedahs/Desktop/NEWMR/BMI/BMI_38.tsv"
exposure_data <- read.table(exposure_file, header = TRUE, sep = "\t")

# Load outcome summary data
outcome_file <- "/Users/sanjeedahs/Desktop/MR_PROJECT/outcome_data/AF/filtered_AF_GWAS_hg38.tsv"
outcome_data <- read.table(outcome_file, header = TRUE, sep = "\t")

# Format the exposure data
exposure_data <- format_data(
  exposure_data,
  type = "exposure",
  snp_col = "SNP",
  beta_col = "beta",
  se_col = "se",
  effect_allele_col = "effect_allele",
  other_allele_col = "other_allele",
  eaf_col = "eaf",
  pval_col = "pval",
  chr_col = "chr",
  pos_col = "bp_loc" 
)

# Format the outcome data
outcome_data <- format_data(
  outcome_data,
  type = "outcome",
  snp_col = "SNP",
  beta_col = "beta",
  se_col = "se",
  effect_allele_col = "effect_allele",
  other_allele_col = "other_allele",
  eaf_col = "eaf",
  pval_col = "pval",
  chr_col = "chromosome",
  pos_col = "bp_loc_hg38"
)

# Check the formatted data
head(exposure_data)
head(outcome_data)
```

3. Perform LD clumping

```{r}

# Set API endpoint
options(ieugwasr_api = 'gwas-api.mrcieu.ac.uk/')

# Perform LD clumping
BMI_clump <- clump_data(exposure_data, clump_r2 = 0.01, pop = "EUR") 

```

4. Harmonise the clumped and outcome data

```{r}

# Harmonise the clumped and outcome data
BMI_harmonised_data <- harmonise_data(BMI_clump, outcome_data)

```

5. Perform univariable MR

```{r}

# Perform univariable MR analysis
BMI_mr_results <- mr(BMI_harmonised_data)

```

6. Test for heterogeneity

```{r}

# Test for heterogeneity
BMI_heterogeneity_results <- mr_heterogeneity(BMI_harmonised_data)

```

7. Test for pleiotropy

```{r}
# Test for pleiotropy
BMI_pleiotropy_results <- mr_pleiotropy_test(BMI_harmonised_data)


```

8. View the results for univariable MR, heterogeneity and pleiotropy

```{r}
# Print the results
print("Mendelian Randomisation Results:")
print(BMI_mr_results)

print("Heterogeneity Test Results:")
print(BMI_heterogeneity_results)

print("Pleiotropy Test Results:")
print(BMI_pleiotropy_results)

```

9. Extract the 95% confidence intervals for the univariable MR results

```{r}
# Calculate 95% Confidence Intervals
BMI_mr_results <- BMI_mr_results %>%
  mutate(lower_ci = b - 1.96 * se,
         upper_ci = b + 1.96 * se)

```


```{r}
# Print the results
print("Mendelian Randomisation Results with 95% Confidence Intervals:")
print(BMI_mr_results)

```

10. Find the number of SNPs after clumping and harmonisation
```{r}
print(paste("Number of SNPs after clumping:", nrow(BMI_clump)))
print(paste("Number of SNPs after harmonisation:", nrow(BMI_harmonised_data)))
```

11. MR IVW analysis using 'MendelianRandomization' package

11.1. Install 'MendelianRandomization' package

```{r}
# install required package
install.packages("MendelianRandomization")
```

11.2. Load required package

```{r}
library(MendelianRandomization) 
```

11.3. Run MR IVW 
```{r}
# Create the MR input object
mrdata <- mr_input(
  bx = BMI_harmonised_data$beta.exposure,
  bxse = BMI_harmonised_data$se.exposure,
  by = BMI_harmonised_data$beta.outcome,
  byse = BMI_harmonised_data$se.outcome,
  snps = BMI_harmonised_data$SNP
)

# Check the MR input object
print(mrdata)
str(mrdata)

# Run the MR IVW analysis using the correct slots
result_ivw <- mr_ivw(b_exp = mrdata@betaX, b_out = mrdata@betaY, se_exp = mrdata@betaXse, se_out = mrdata@betaYse)

# Extract detailed results from the list
ivw_estimate <- result_ivw$b
ivw_se <- result_ivw$se
ivw_pval <- result_ivw$pval
ivw_ci_lower <- ivw_estimate - 1.96 * ivw_se
ivw_ci_upper <- ivw_estimate + 1.96 * ivw_se

# Print detailed IVW results
print(paste("Estimate: ", ivw_estimate))
print(paste("Standard Error: ", ivw_se))
print(paste("95% Confidence Interval: [", ivw_ci_lower, ", ", ivw_ci_upper, "]", sep = ""))
print(paste("P-value: ", format(ivw_pval, scientific = TRUE)))

```

12. Leave-one-out analysis

```{r}
# Leave-one-out analysis
loo_results <- mr_leaveoneout(BMI_harmonised_data)
mr_leaveoneout_plot <- mr_leaveoneout_plot(loo_results)
print(mr_leaveoneout_plot)

```

13. Visualising results

13.1. Forest plot

```{r}
# Calculate 95% Confidence Intervals for individual SNPs
BMI_harmonised_data <- BMI_harmonised_data %>%
  mutate(lower_ci = beta.outcome - 1.96 * se.outcome,
         upper_ci = beta.outcome + 1.96 * se.outcome)

# Create forest plot
forest_plot <- ggplot(BMI_harmonised_data, aes(y = reorder(SNP, beta.outcome), x = beta.outcome)) +
  geom_point() +
  geom_errorbarh(aes(xmin = lower_ci, xmax = upper_ci), height = 0.2) +
  labs(x = "MR effect size for 'BMI' on 'AF' (Beta with 95% CI)", y = "SNP", title = "Forest Plot of MR Results for Individual SNPs for BMI and AF") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 3)) 

# Print forest plot
print(forest_plot)
```

13.2. Funnel plot

```{r}

# Create a funnel plot using individual SNPs
funnel_plot <- ggplot(BMI_harmonised_data, aes(x = beta.outcome, y = 1 / se.outcome)) +
  geom_point(alpha = 0.5, color = "blue") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  labs(x = expression("Genetic association with outcome " ~ beta[IV]), 
       y = expression("Inverse Standard Error " ~ 1 / SE[IV]), 
       title = "Funnel Plot to Inspect Horizontal Pleiotropy for BMI and AF") +
  theme_minimal() +
  theme(legend.position = "none")  # Remove the legend

# Print funnel plot
print(funnel_plot)
```

13.3. Scatter plot
```{r}
# Generate scatter plot
scatter_plot <- mr_scatter_plot(BMI_mr_results, BMI_harmonised_data)

# Print scatter plot
print(scatter_plot[[1]]) 
```

14. View and save the individual IV's

```{r}
# View the harmonized data to see each SNP used as an IV
head(BMI_harmonised_data)

# Save the harmonized data to a CSV file in the specified directory
output_file <- "/Users/sanjeedahs/Desktop/NEWMR/BMI/BMI_harmonized_SNPs.csv"
write.csv(BMI_harmonised_data, output_file, row.names = FALSE)

# Print confirmation
print(paste("Harmonized SNPs data saved to:", output_file))
```
```

