
1.1. Install necessary packages

```{r}
# Install necessary packages
install.packages("devtools")
devtools::install_github("MRCIEU/TwoSampleMR")
devtools::install_github("MRCIEU/ieugwasr")
install.packages("MendelianRandomization")
```

1.2. Load necessary packages

```{r}
# Load the required libraries
library(TwoSampleMR)
library(dplyr)
```

2. Load and format the outcome and summary data

```{r}
# Load exposure summary data
exposure_file <- "/Users/sanjeedahs/Desktop/NEWMR/CRP/CRP_38.tsv"
exposure_data <- read.table(exposure_file, header = TRUE, sep = "\t")

# outcome data is available in the Global environment

# Format the exposure data
exposure_data <- format_data(
  exposure_data,
  type = "exposure",
  snp_col = "SNP",
  beta_col = "beta",
  se_col = "se",
  effect_allele_col = "effect_allele",
  other_allele_col = "other_allele",
  eaf_col = "eaf",
  pval_col = "pval",
  chr_col = "chr",
  pos_col = "bp_loc"
)

# Check the formatted data
head(exposure_data)
head(outcome_data)
```

3. Perform LD clumping

```{r}
# Set API endpoint
options(ieugwasr_api = 'gwas-api.mrcieu.ac.uk/')

# Perform LD clumping
CRP_clump <- clump_data(exposure_data, clump_r2 = 0.01, pop = "EUR")

```

4. Harmonise the clumped and outcome data

```{r}

# Harmonise the data
CRP_harmonised_data <- harmonise_data(CRP_clump, outcome_data)

# Check the number of SNPs after clumping and harmonization
print(paste("Number of SNPs after clumping:", nrow(CRP_clump)))
print(paste("Number of SNPs after harmonization:", nrow(CRP_harmonised_data)))

```

5. Perform univariable MR

```{r}
# Perform Univariable Mendelian Randomisation analysis
CRP_mr_results <- mr(CRP_harmonised_data)

```

6. Test for heterogeneity 

```{r}
# Test for heterogeneity
CRP_heterogeneity_results <- mr_heterogeneity(CRP_harmonised_data)
```

7. Test for pleiotropy

```{r}
# Test for pleiotropy
CRP_pleiotropy_results <- mr_pleiotropy_test(CRP_harmonised_data)

```

8. Calculate 95% confidence intervals: 

```{r}
# Calculate 95% Confidence Intervals
CRP_mr_results <- CRP_mr_results %>%
  mutate(lower_ci = b - 1.96 * se,
         upper_ci = b + 1.96 * se)

```

9. Print results:

```{r}
# Print the results
print("Mendelian Randomisation Results with 95% Confidence Intervals:")
print(CRP_mr_results)

print("Heterogeneity Test Results:")
print(CRP_heterogeneity_results)

print("Pleiotropy Test Results:")
print(CRP_pleiotropy_results)

```

10. MR IVW analysis using the 'MendelianRandomization' package: 

10.1. Install 'MendelianRandomization' package

```{r}
# install required package
install.packages("MendelianRandomization")
```

10.2. Load required package

```{r}
library(MendelianRandomization) 
```

10.3. Run MR IVW 
```{r}
# Create the MR input object
mrdata <- mr_input(
  bx = CRP_harmonised_data$beta.exposure,
  bxse = CRP_harmonised_data$se.exposure,
  by = CRP_harmonised_data$beta.outcome,
  byse = CRP_harmonised_data$se.outcome,
  snps = CRP_harmonised_data$SNP
)

# Check the MR input object
print(mrdata)
str(mrdata)

# Run the MR IVW analysis using the correct slots
result_ivw <- mr_ivw(b_exp = mrdata@betaX, b_out = mrdata@betaY, se_exp = mrdata@betaXse, se_out = mrdata@betaYse)

# Extract detailed results from the list
ivw_estimate <- result_ivw$b
ivw_se <- result_ivw$se
ivw_pval <- result_ivw$pval
ivw_ci_lower <- ivw_estimate - 1.96 * ivw_se
ivw_ci_upper <- ivw_estimate + 1.96 * ivw_se

# Print detailed IVW results
print(paste("Estimate: ", ivw_estimate))
print(paste("Standard Error: ", ivw_se))
print(paste("95% Confidence Interval: [", ivw_ci_lower, ", ", ivw_ci_upper, "]", sep = ""))
print(paste("P-value: ", format(ivw_pval, scientific = TRUE)))

```
11. Leave-one-out analysis

```{r}

# Load necessary packages
library(ggplot2)

# Perform leave-one-out analysis
loo_results <- mr_leaveoneout(CRP_harmonised_data)
mr_leaveoneout_plot <- mr_leaveoneout_plot(loo_results)

# Print leave-one-out plot
print(mr_leaveoneout_plot)


```
12. Visualise results

12.1 Scatter plot

```{r}
# Generate scatter plot
scatter_plot <- mr_scatter_plot(CRP_mr_results, CRP_harmonised_data)

# Print scatter plot
print(scatter_plot[[1]]) 
```
12.2. Forest plot

```{r}
# Calculate 95% Confidence Intervals for individual SNPs
CRP_harmonised_data <- CRP_harmonised_data %>%
  mutate(lower_ci = beta.outcome - 1.96 * se.outcome,
         upper_ci = beta.outcome + 1.96 * se.outcome)

# Create forest plot
forest_plot <- ggplot(CRP_harmonised_data, aes(y = reorder(SNP, beta.outcome), x = beta.outcome)) +
  geom_point() +
  geom_errorbarh(aes(xmin = lower_ci, xmax = upper_ci), height = 0.2) +
  labs(x = "MR effect size for 'CRP' on 'AF' (Beta with 95% CI)", y = "SNP", title = "Forest Plot of MR Results for Individual SNPs for CRP and AF") +
  theme_minimal() +
  theme(axis.text.y = element_text(size = 3)) 

# Print forest plot
print(forest_plot)
```

12.3. Funnel plot

```{r}

# Create a funnel plot using individual SNPs
funnel_plot <- ggplot(CRP_harmonised_data, aes(x = beta.outcome, y = 1 / se.outcome)) +
  geom_point(alpha = 0.5, color = "blue") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  labs(x = expression("Genetic association with outcome " ~ beta[IV]), 
       y = expression("Inverse Standard Error " ~ 1 / SE[IV]), 
       title = "Funnel Plot to Inspect Horizontal Pleiotropy for CRP and AF") +
  theme_minimal() +
  theme(legend.position = "none")  

# Print funnel plot
print(funnel_plot)
```

13. View and save the individual IV's:

```{r}
# View the harmonized data to see each SNP used as an IV
head(CRP_harmonised_data)

# Save the harmonized data to a CSV file in the specified directory
output_file <- "/Users/sanjeedahs/Desktop/NEWMR/CRP/CRP_harmonized_SNPs.csv"
write.csv(CRP_harmonised_data, output_file, row.names = FALSE)

# Print confirmation
print(paste("Harmonized SNPs data saved to:", output_file))
```







